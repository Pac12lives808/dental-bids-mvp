// Prisma schema for dental bidding marketplace
// HIPAA-lean design: minimal PHI, anonymized bidding

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum Role {
  PATIENT
  OFFICE
  ADMIN
}

enum City {
  GILBERT
  MESA
  CHANDLER
  TEMPE
  SCOTTSDALE
}

enum ProcedureType {
  EMERGENCY_VISIT
  CLEANING_EXAM
  EXTRACTION
  INVISALIGN_CONSULT
  IMPLANT_CONSULT
  WHITENING
}

enum CaseStatus {
  OPEN
  EXPIRED
  ACCEPTED
  CLOSED
}

enum BidStatus {
  SUBMITTED
  WITHDRAWN
  ACCEPTED
  REJECTED
}

enum SubscriptionStatus {
  INACTIVE
  ACTIVE
  PAST_DUE
  CANCELED
}

model User {
  id           String   @id @default(uuid())
  email        String   @unique
  passwordHash String
  role         Role     @default(PATIENT)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  patientProfile PatientProfile?
  officeProfile  OfficeProfile?
  cases          Case[]        @relation("PatientCases")
  bids           Bid[]

  @@index([email])
}

model PatientProfile {
  id        String   @id @default(uuid())
  userId    String   @unique
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model OfficeProfile {
  id                   String             @id @default(uuid())
  userId               String             @unique
  user                 User               @relation(fields: [userId], references: [id], onDelete: Cascade)
  officeName           String
  city                 City
  procedures           ProcedureType[]    @default([])
  subscriptionStatus   SubscriptionStatus @default(INACTIVE)
  stripeCustomerId     String? @unique
  stripeSubscriptionId String? @unique
  tier                 String?
    subscriptionPriceId  String?
  currentPeriodEnd     DateTime?
  isVerified           Boolean            @default(false)
  createdAt            DateTime           @default(now())
  updatedAt            DateTime @updatedAt
  subscription OfficeSubscription? @relation("OfficeSubscriptionRelation")

  @@index([city])
}

model OfficeSubscription {
  id                      String   @id @default(uuid())
  officeId                String   @unique
  office                  OfficeProfile @relation("OfficeSubscriptionRelation", fields: [officeId], references: [id], onDelete: Cascade)
  tier                    String
  status                  SubscriptionStatus @default(INACTIVE)
  estimatesLimitMonthly   Int
  estimatesUsedThisMonth  Int     @default(0)
  stripeCustomerId        String?
  stripeSubscriptionId    String?
  currentPeriodStart      DateTime?
  currentPeriodEnd        DateTime?
  createdAt               DateTime @default(now())
  updatedAt               DateTime @updatedAt

  @@index([officeId])
  @@index([status])
  @@index([stripeSubscriptionId])
}

model Case {
  id          String        @id @default(uuid())
  patientId   String
  patient     User          @relation(fields: [patientId], references: [id], name: "PatientCases")
  city        City
  procedure   ProcedureType
  description String?
  status      CaseStatus    @default(OPEN)
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt

  bids        Bid[]

  @@index([patientId])
  @@index([status])
}

model Bid {
  id          String     @id @default(uuid())
  caseId      String
  case        Case       @relation(fields: [caseId], references: [id], onDelete: Cascade)
  officeId    String
  office      User       @relation(fields: [officeId], references: [id])
  priceCents  Int
  availability String?
  notes       String?
  status      BidStatus  @default(SUBMITTED)
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt

  @@unique([caseId, officeId])
  @@index([caseId])
  @@index([officeId])
}

model AuditLog {
  id          String   @id @default(uuid())
  actorUserId String?
  action      String
  entity      String
  entityId    String
  metadata    Json?
  createdAt   DateTime @default(now())
  @@index([actorUserId])
  @@index([action])
}
